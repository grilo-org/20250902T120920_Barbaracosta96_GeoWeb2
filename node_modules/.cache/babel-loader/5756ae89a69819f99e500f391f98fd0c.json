{"ast":null,"code":"import PDFNumber from \"../objects/PDFNumber\";\nimport PDFDict from \"../objects/PDFDict\";\nimport PDFName from \"../objects/PDFName\";\nimport PDFArray from \"../objects/PDFArray\";\nimport PDFRef from \"../objects/PDFRef\";\nimport PDFAcroTerminal from \"./PDFAcroTerminal\";\nimport PDFAcroNonTerminal from \"./PDFAcroNonTerminal\";\nimport PDFAcroSignature from \"./PDFAcroSignature\";\nimport PDFAcroText from \"./PDFAcroText\";\nimport PDFAcroPushButton from \"./PDFAcroPushButton\";\nimport PDFAcroRadioButton from \"./PDFAcroRadioButton\";\nimport PDFAcroCheckBox from \"./PDFAcroCheckBox\";\nimport PDFAcroComboBox from \"./PDFAcroComboBox\";\nimport PDFAcroListBox from \"./PDFAcroListBox\";\nimport { AcroButtonFlags, AcroChoiceFlags } from \"./flags\";\nexport var createPDFAcroFields = function createPDFAcroFields(kidDicts) {\n  if (!kidDicts) return [];\n  var kids = [];\n  for (var idx = 0, len = kidDicts.size(); idx < len; idx++) {\n    var ref = kidDicts.get(idx);\n    var dict = kidDicts.lookup(idx);\n    // if (dict instanceof PDFDict) kids.push(PDFAcroField.fromDict(dict));\n    if (ref instanceof PDFRef && dict instanceof PDFDict) {\n      kids.push([createPDFAcroField(dict, ref), ref]);\n    }\n  }\n  return kids;\n};\nexport var createPDFAcroField = function createPDFAcroField(dict, ref) {\n  var isNonTerminal = isNonTerminalAcroField(dict);\n  if (isNonTerminal) return PDFAcroNonTerminal.fromDict(dict, ref);\n  return createPDFAcroTerminal(dict, ref);\n};\n// TODO: Maybe just check if the dict is *not* a widget? That might be better.\n// According to the PDF spec:\n//\n//   > A field's children in the hierarchy may also include widget annotations\n//   > that define its appearance on the page. A field that has children that\n//   > are fields is called a non-terminal field. A field that does not have\n//   > children that are fields is called a terminal field.\n//\n// The spec is not entirely clear about how to determine whether a given\n// dictionary represents an acrofield or a widget annotation. So we will assume\n// that a dictionary is an acrofield if it is a member of the `/Kids` array\n// and it contains a `/T` entry (widgets do not have `/T` entries). This isn't\n// a bullet proof solution, because the `/T` entry is technically defined as\n// optional for acrofields by the PDF spec. But in practice all acrofields seem\n// to have a `/T` entry defined.\nvar isNonTerminalAcroField = function isNonTerminalAcroField(dict) {\n  var kids = dict.lookup(PDFName.of('Kids'));\n  if (kids instanceof PDFArray) {\n    for (var idx = 0, len = kids.size(); idx < len; idx++) {\n      var kid = kids.lookup(idx);\n      var kidIsField = kid instanceof PDFDict && kid.has(PDFName.of('T'));\n      if (kidIsField) return true;\n    }\n  }\n  return false;\n};\nvar createPDFAcroTerminal = function createPDFAcroTerminal(dict, ref) {\n  var ftNameOrRef = getInheritableAttribute(dict, PDFName.of('FT'));\n  var type = dict.context.lookup(ftNameOrRef, PDFName);\n  if (type === PDFName.of('Btn')) return createPDFAcroButton(dict, ref);\n  if (type === PDFName.of('Ch')) return createPDFAcroChoice(dict, ref);\n  if (type === PDFName.of('Tx')) return PDFAcroText.fromDict(dict, ref);\n  if (type === PDFName.of('Sig')) return PDFAcroSignature.fromDict(dict, ref);\n  // We should never reach this line. But there are a lot of weird PDFs out\n  // there. So, just to be safe, we'll try to handle things gracefully instead\n  // of throwing an error.\n  return PDFAcroTerminal.fromDict(dict, ref);\n};\nvar createPDFAcroButton = function createPDFAcroButton(dict, ref) {\n  var _a;\n  var ffNumberOrRef = getInheritableAttribute(dict, PDFName.of('Ff'));\n  var ffNumber = dict.context.lookupMaybe(ffNumberOrRef, PDFNumber);\n  var flags = (_a = ffNumber === null || ffNumber === void 0 ? void 0 : ffNumber.asNumber()) !== null && _a !== void 0 ? _a : 0;\n  if (flagIsSet(flags, AcroButtonFlags.PushButton)) {\n    return PDFAcroPushButton.fromDict(dict, ref);\n  } else if (flagIsSet(flags, AcroButtonFlags.Radio)) {\n    return PDFAcroRadioButton.fromDict(dict, ref);\n  } else {\n    return PDFAcroCheckBox.fromDict(dict, ref);\n  }\n};\nvar createPDFAcroChoice = function createPDFAcroChoice(dict, ref) {\n  var _a;\n  var ffNumberOrRef = getInheritableAttribute(dict, PDFName.of('Ff'));\n  var ffNumber = dict.context.lookupMaybe(ffNumberOrRef, PDFNumber);\n  var flags = (_a = ffNumber === null || ffNumber === void 0 ? void 0 : ffNumber.asNumber()) !== null && _a !== void 0 ? _a : 0;\n  if (flagIsSet(flags, AcroChoiceFlags.Combo)) {\n    return PDFAcroComboBox.fromDict(dict, ref);\n  } else {\n    return PDFAcroListBox.fromDict(dict, ref);\n  }\n};\nvar flagIsSet = function flagIsSet(flags, flag) {\n  return (flags & flag) !== 0;\n};\nvar getInheritableAttribute = function getInheritableAttribute(startNode, name) {\n  var attribute;\n  ascend(startNode, function (node) {\n    if (!attribute) attribute = node.get(name);\n  });\n  return attribute;\n};\nvar ascend = function ascend(startNode, visitor) {\n  visitor(startNode);\n  var Parent = startNode.lookupMaybe(PDFName.of('Parent'), PDFDict);\n  if (Parent) ascend(Parent, visitor);\n};","map":{"version":3,"mappings":"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","names":["PDFNumber","PDFDict","PDFName","PDFArray","PDFRef","PDFAcroTerminal","PDFAcroNonTerminal","PDFAcroSignature","PDFAcroText","PDFAcroPushButton","PDFAcroRadioButton","PDFAcroCheckBox","PDFAcroComboBox","PDFAcroListBox","AcroButtonFlags","AcroChoiceFlags","createPDFAcroFields","kidDicts","kids","idx","len","size","ref","get","dict","lookup","push","createPDFAcroField","isNonTerminal","isNonTerminalAcroField","fromDict","createPDFAcroTerminal","of","kid","kidIsField","has","ftNameOrRef","getInheritableAttribute","type","context","createPDFAcroButton","createPDFAcroChoice","ffNumberOrRef","ffNumber","lookupMaybe","flags","asNumber","flagIsSet","PushButton","Radio","Combo","flag","startNode","name","attribute","ascend","node","visitor","Parent"],"sourceRoot":"","sources":["../../../src/core/acroform/utils.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}