{"ast":null,"code":"import { __awaiter, __generator } from \"tslib\";\nimport { MissingPageContentsEmbeddingError, UnrecognizedStreamTypeError } from \"../errors\";\nimport PDFNumber from \"../objects/PDFNumber\";\nimport PDFRawStream from \"../objects/PDFRawStream\";\nimport PDFStream from \"../objects/PDFStream\";\nimport { decodePDFRawStream } from \"../streams/decode\";\nimport PDFContentStream from \"../structures/PDFContentStream\";\nimport CharCodes from \"../syntax/CharCodes\";\nimport { mergeIntoTypedArray } from \"../../utils\";\nvar fullPageBoundingBox = function fullPageBoundingBox(page) {\n  var mediaBox = page.MediaBox();\n  var width = mediaBox.lookup(2, PDFNumber).asNumber() - mediaBox.lookup(0, PDFNumber).asNumber();\n  var height = mediaBox.lookup(3, PDFNumber).asNumber() - mediaBox.lookup(1, PDFNumber).asNumber();\n  return {\n    left: 0,\n    bottom: 0,\n    right: width,\n    top: height\n  };\n};\n// Returns the identity matrix, modified to position the content of the given\n// bounding box at (0, 0).\nvar boundingBoxAdjustedMatrix = function boundingBoxAdjustedMatrix(bb) {\n  return [1, 0, 0, 1, -bb.left, -bb.bottom];\n};\nvar PDFPageEmbedder = /** @class */function () {\n  function PDFPageEmbedder(page, boundingBox, transformationMatrix) {\n    this.page = page;\n    var bb = boundingBox !== null && boundingBox !== void 0 ? boundingBox : fullPageBoundingBox(page);\n    this.width = bb.right - bb.left;\n    this.height = bb.top - bb.bottom;\n    this.boundingBox = bb;\n    this.transformationMatrix = transformationMatrix !== null && transformationMatrix !== void 0 ? transformationMatrix : boundingBoxAdjustedMatrix(bb);\n  }\n  PDFPageEmbedder.for = function (page, boundingBox, transformationMatrix) {\n    return __awaiter(this, void 0, void 0, function () {\n      return __generator(this, function (_a) {\n        return [2 /*return*/, new PDFPageEmbedder(page, boundingBox, transformationMatrix)];\n      });\n    });\n  };\n  PDFPageEmbedder.prototype.embedIntoContext = function (context, ref) {\n    return __awaiter(this, void 0, void 0, function () {\n      var _a, Contents, Resources, decodedContents, _b, left, bottom, right, top, xObject;\n      return __generator(this, function (_c) {\n        _a = this.page.normalizedEntries(), Contents = _a.Contents, Resources = _a.Resources;\n        if (!Contents) throw new MissingPageContentsEmbeddingError();\n        decodedContents = this.decodeContents(Contents);\n        _b = this.boundingBox, left = _b.left, bottom = _b.bottom, right = _b.right, top = _b.top;\n        xObject = context.flateStream(decodedContents, {\n          Type: 'XObject',\n          Subtype: 'Form',\n          FormType: 1,\n          BBox: [left, bottom, right, top],\n          Matrix: this.transformationMatrix,\n          Resources: Resources\n        });\n        if (ref) {\n          context.assign(ref, xObject);\n          return [2 /*return*/, ref];\n        } else {\n          return [2 /*return*/, context.register(xObject)];\n        }\n        return [2 /*return*/];\n      });\n    });\n  };\n  // `contents` is an array of streams which are merged to include them in the XObject.\n  // This methods extracts each stream and joins them with a newline character.\n  PDFPageEmbedder.prototype.decodeContents = function (contents) {\n    var newline = Uint8Array.of(CharCodes.Newline);\n    var decodedContents = [];\n    for (var idx = 0, len = contents.size(); idx < len; idx++) {\n      var stream = contents.lookup(idx, PDFStream);\n      var content = void 0;\n      if (stream instanceof PDFRawStream) {\n        content = decodePDFRawStream(stream).decode();\n      } else if (stream instanceof PDFContentStream) {\n        content = stream.getUnencodedContents();\n      } else {\n        throw new UnrecognizedStreamTypeError(stream);\n      }\n      decodedContents.push(content, newline);\n    }\n    return mergeIntoTypedArray.apply(void 0, decodedContents);\n  };\n  return PDFPageEmbedder;\n}();\nexport default PDFPageEmbedder;","map":{"version":3,"mappings":"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","names":["MissingPageContentsEmbeddingError","UnrecognizedStreamTypeError","PDFNumber","PDFRawStream","PDFStream","decodePDFRawStream","PDFContentStream","CharCodes","mergeIntoTypedArray","fullPageBoundingBox","page","mediaBox","MediaBox","width","lookup","asNumber","height","left","bottom","right","top","boundingBoxAdjustedMatrix","bb","boundingBox","transformationMatrix","PDFPageEmbedder","context","ref","_a","normalizedEntries","Contents","Resources","decodedContents","decodeContents","_b","xObject","flateStream","Type","Subtype","FormType","BBox","Matrix","assign","register","contents","newline","Uint8Array","of","Newline","idx","len","size","stream","content","decode","getUnencodedContents","push"],"sourceRoot":"","sources":["../../../src/core/embedders/PDFPageEmbedder.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}